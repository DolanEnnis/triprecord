<div class="container">
  <h1>User Management</h1>

  <!-- Shannon Daily Diary Monitoring Status -->
  @if (metadata(); as meta) {
    <mat-card style="margin-bottom: 24px;">
      <mat-card-header>
        <mat-card-title style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
          <span style="display: flex; align-items: center; gap: 8px;">
            <mat-icon>monitor_heart</mat-icon>
            Shannon Daily Diary Monitoring
          </span>
          <mat-slide-toggle 
            [checked]="meta.watchtower_enabled"
            (change)="toggleWatchtower($event.checked)"
            color="primary">
            {{ meta.watchtower_enabled ? 'Running' : 'Paused' }}
          </mat-slide-toggle>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 12px;">
          
          <!-- Status -->
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Status</div>
            <div style="display: flex; align-items: center; gap: 4px;">
              <mat-icon [style.color]="meta.watchtower_enabled ? '#4caf50' : '#ff9800'" style="font-size: 18px; width: 18px; height: 18px;">
                {{ meta.watchtower_enabled ? 'play_circle' : 'pause_circle' }}
              </mat-icon>
              <strong>{{ meta.watchtower_enabled ? 'Monitoring Active' : 'Paused' }}</strong>
            </div>
          </div>

          <!-- Last Check -->
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Last Check</div>
            @if (meta.last_check; as lastCheck) {
              <strong>{{ lastCheck.toDate() | date:'dd/MM HH:mm' }}</strong>
            } @else {
              <strong>Never</strong>
            }
          </div>

          <!-- Last Processed -->
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Last Processed</div>
            @if (meta.last_processed; as lastProc) {
              <strong>{{ lastProc.toDate() | date:'dd/MM HH:mm' }}</strong>
            } @else {
              <strong>Never</strong>
            }
          </div>

          <!-- Update Available -->
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Update Available</div>
            <strong [style.color]="meta.update_available ? '#4caf50' : 'inherit'">
              {{ meta.update_available ? 'Yes' : 'No' }}
            </strong>
          </div>

          <!-- Processing Status -->
          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Processing</div>
            <strong [style.color]="meta.processing ? '#ff9800' : 'inherit'">
              {{ meta.processing ? 'In Progress' : 'Idle' }}
            </strong>
          </div>

        </div>
      </mat-card-content>
    </mat-card>
  }

  <mat-form-field appearance="outline">
    <mat-label>Filter Users</mat-label>
    <input matInput (keyup)="applyFilter($event)" placeholder="Search by name or email">
  </mat-form-field>

  <div class="table-container mat-elevation-z8">
    <table mat-table [dataSource]="dataSource" matSort matSortActive="lastLoginTrip" matSortDirection="desc">

      <!-- Name Column -->
      <ng-container matColumnDef="displayName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
        <td mat-cell *matCellDef="let user">{{ user.displayName }}</td>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
        <td mat-cell *matCellDef="let user">{{ user.email }}</td>
      </ng-container>

      <!-- Last Login Column -->
      <ng-container matColumnDef="lastLoginTrip">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Login</th>
        <td mat-cell *matCellDef="let user">{{ user.lastLoginTrip?.toDate() | date:'dd-MM-yy HH:mm' }}</td>
      </ng-container>

      <!-- Last Sheet View Column -->
      <ng-container matColumnDef="lastSheetView">
        <th mat-header-cell *matHeaderCellDef>Last Sheet View</th>
        <td mat-cell *matCellDef="let user">
          @if (user.sheet_info_last_viewed; as lastView) {
            {{ lastView.toDate() | date:'dd/MM HH:mm' }}
          } @else {
            Never
          }
        </td>
      </ng-container>

      <!-- User Type Column -->
      <ng-container matColumnDef="userType">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>User Type</th>
        <td mat-cell *matCellDef="let user">
          <mat-select [(ngModel)]="user.userType" (selectionChange)="updateUserType(user)">
            <mat-option value="pilot">Pilot</mat-option>
            <mat-option value="admin">Admin</mat-option>
            <mat-option value="sfpc">SFPC</mat-option>
            <mat-option value="viewer">Viewer</mat-option>
            <mat-option value="other">Other</mat-option>
          </mat-select>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let user">
          <button mat-icon-button color="warn" (click)="deleteUser(user)" matTooltip="Delete User">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">No users match your filter criteria.</td>
      </tr>
    </table>
  </div>

  <!-- Ship Deduplication Section -->
  <h2 style="margin-top: 48px;">Ship Deduplication</h2>
  
  <mat-card style="margin-bottom: 24px;">
    <mat-card-header>
      <mat-card-title style="display: flex; align-items: center; gap: 8px;">
        <mat-icon>merge_type</mat-icon>
        Find & Merge Duplicate Ships
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p style="color: #666; margin-bottom: 16px;">
        Find ships with the same IMO number and merge them into a single record.
        All visits from the merged ship will be transferred to the kept ship.
      </p>
      
      <button 
        mat-raised-button 
        color="primary"
        [disabled]="isLoadingDuplicates()"
        (click)="findDuplicateShips()">
        @if (isLoadingDuplicates()) {
          <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
          Searching...
        } @else {
          <ng-container>
            <mat-icon>search</mat-icon>
            Find Duplicate Ships (by IMO)
          </ng-container>
        }
      </button>
      
      <!-- Duplicate Groups Display -->
      @if (hasCheckedDuplicates()) {
        <div style="margin-top: 24px;">
          @if (duplicateGroups().length === 0) {
            <div class="no-duplicates-message" style="padding: 16px; background: #e8f5e9; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <mat-icon style="color: #4caf50;">check_circle</mat-icon>
              <span>No duplicate ships found! Your ship database is clean.</span>
            </div>
          } @else {
          <h3>Found {{ duplicateGroups().length }} Duplicate Group(s)</h3>
            
            @for (group of duplicateGroups(); track (group.matchType === 'imo' ? group.imoNumber : group.shipName)) {
              <div class="duplicate-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                  <div>
                    <!-- Show different badge based on match type -->
                    @if (group.matchType === 'imo') {
                      <span style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 4px; font-weight: 500; margin-right: 8px;">
                        IMO: {{ group.imoNumber }}
                      </span>
                    } @else {
                      <span style="background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 4px; font-weight: 500; margin-right: 8px;">
                        Name: {{ group.shipName }}
                      </span>
                    }
                    <span style="color: #666;">({{ group.ships.length }} ships)</span>
                  </div>
                  <button 
                    mat-raised-button 
                    color="warn"
                    (click)="openMergeDialog(group)">
                    <mat-icon>merge_type</mat-icon>
                    Merge
                  </button>
                </div>
                
                <div class="ship-list" style="display: flex; flex-wrap: wrap; gap: 12px;">
                  @for (ship of group.ships; track ship.id) {
                    <div class="ship-card" style="background: white; padding: 12px 16px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-width: 200px;">
                      <div style="font-weight: 600;">{{ ship.shipName }}</div>
                      <div style="display: flex; gap: 8px; margin-top: 4px; flex-wrap: wrap;">
                        <span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">
                          {{ ship.grossTonnage | number }} GT
                        </span>
                        @if (ship.imoNumber) {
                          <span style="color: #666; font-size: 0.85em;">
                            IMO: {{ ship.imoNumber }}
                          </span>
                        }
                        @if (ship.shipNotes) {
                          <span style="color: #666; font-size: 0.85em; display: flex; align-items: center; gap: 2px;">
                            <mat-icon inline style="font-size: 14px; width: 14px; height: 14px;">notes</mat-icon>
                            Notes
                          </span>
                        }
                        @if (ship.marineTrafficLink) {
                          <span style="color: #666; font-size: 0.85em; display: flex; align-items: center; gap: 2px;">
                            <mat-icon inline style="font-size: 14px; width: 14px; height: 14px;">link</mat-icon>
                            MT
                          </span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          }
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- System Maintenance Section -->
  <h2 style="margin-top: 48px;">System Maintenance</h2>
  
  <mat-card style="margin-bottom: 48px;">
    <mat-card-header>
      <mat-card-title style="display: flex; align-items: center; gap: 8px;">
        <mat-icon>build</mat-icon>
        Legacy Data Sync
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
        <strong>Dual-Run Protection:</strong> The "New System" now automatically syncs data from the "Old System" (/charges).
        <br>
        However, if you suspect data from the <strong>past 5 days</strong> is missing, run this manual sync.
      </div>
      
      <p style="color: #666; margin-bottom: 16px;">
        This tool scans all charges created or modified since Feb 2nd, 2026, and ensures they exist as confirmed trips in the new database.
        It is safe to run multiple times (it updates existing records without duplication).
      </p>
      
      <button 
        mat-raised-button 
        color="accent" 
        (click)="syncLegacyCharges()" 
        [disabled]="isSyncingCharges()">
        @if (isSyncingCharges()) {
          <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
          Syncing...
        } @else {
          <ng-container>
            <mat-icon>sync</mat-icon>
            Sync Legacy Charges Now
          </ng-container>
        }
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Environmental Data Import Section -->
  <h2 style="margin-top: 48px;">Environmental Data Import</h2>
  
  <mat-card style="margin-bottom: 48px;">
    <mat-card-header>
      <mat-card-title style="display: flex; align-items: center; gap: 8px;">
        <mat-icon>cloud_upload</mat-icon>
        Upload Yearly Tide CSV
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div style="background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
        <strong>Instructions for Admin:</strong><br>
        1. Open the latest <strong>"Office Tide"</strong> spreadsheet.<br>
        2. Go to File -> Download -> <strong>Comma Separated Values (.csv)</strong>.<br>
        3. Do not modify the file. Upload it exactly as downloaded below.<br>
        <em>Note: This process overwrites existing data for the uploaded dates.</em>
      </div>
      
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
        <input 
          type="file" 
          #fileInput 
          hidden 
          accept=".csv" 
          (change)="onTideFileSelected($event)">
        
        <button 
          mat-stroked-button 
          color="primary"
          (click)="fileInput.click()"
          [disabled]="isUploadingTides()">
          <mat-icon>attach_file</mat-icon>
          Select CSV File
        </button>
        
        @if (selectedTideFile) {
          <span style="font-family: monospace; font-size: 14px; background: #e0e0e0; padding: 4px 8px; border-radius: 4px;">
            {{ selectedTideFile.name }}
          </span>
        }
      </div>

      <button 
        mat-raised-button 
        color="primary" 
        (click)="uploadTideData()" 
        [disabled]="!selectedTideFile || isUploadingTides()">
        @if (isUploadingTides()) {
          <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
          Uploading & Processing...
        } @else {
          <ng-container>
            <mat-icon>upload</mat-icon>
            Upload Data
          </ng-container>
        }
      </button>
    </mat-card-content>
  </mat-card>

</div>
