<h1 mat-dialog-title>{{ title }}</h1>

<div mat-dialog-content [formGroup]="form">
  <div class="form-grid">
    <mat-form-field>
      <mat-label>Ship</mat-label>
      <input matInput formControlName="ship" [matAutocomplete]="autoShip" required>
      <mat-autocomplete #autoShip="matAutocomplete" [displayWith]="displayShip" (optionSelected)="onShipSelected($event)">
        @for (ship of filteredShips$ | async; track ship.ship) {
          <mat-option [value]="ship">{{ ship.ship }}</mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>

    <mat-form-field>
      <mat-label>GT</mat-label>
      <input matInput type="number" formControlName="gt">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Boarding Date</mat-label>
      <input matInput [matDatepicker]="picker" formControlName="boarding" [max]="maxDate">
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>

    <mat-form-field>
      <mat-label>To/From</mat-label>
      <mat-select formControlName="port">
        @for (port of ports; track port) {
          <mat-option [value]="port">{{ port }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Pilot</mat-label>
      <input 
        matInput 
        formControlName="pilot"
        [matAutocomplete]="pilotAuto"
        (input)="onPilotInput($any($event.target).value)">
      <mat-autocomplete #pilotAuto="matAutocomplete">
        @for (pilot of filteredPilots(); track pilot) {
          <mat-option [value]="pilot === 'Unassigned' ? '' : pilot">
            {{ pilot }}
          </mat-option>
        }
      </mat-autocomplete>
      <mat-error *ngIf="form.get('pilot')?.hasError('invalidPilot')">
        Please select a valid pilot from the list
      </mat-error>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Type</mat-label>
      <mat-select formControlName="typeTrip">
        @for (type of tripTypes; track type) {
          <mat-option [value]="type">{{ type }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field class="full-width">
      <mat-label>Extras (Late Order / Detention etc)</mat-label>
      <textarea matInput formControlName="extra"></textarea>
    </mat-form-field>

    <mat-form-field class="full-width">
      <mat-label>Note</mat-label>
      <textarea matInput formControlName="sailingNote"></textarea>
    </mat-form-field>
  </div>
</div>

<div mat-dialog-actions align="end">
  @if (mode === 'editCharge') {
    <button mat-stroked-button color="warn" (click)="onDelete()" [disabled]="isSaving" style="margin-right: auto;">
      Delete
    </button>
  }
  <button mat-button (click)="onCancel()" [disabled]="isSaving">Cancel</button>
  <button mat-flat-button color="primary" (click)="onSave()" [disabled]="form.invalid || isSaving">
    @if (isSaving) {
      <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
    } @else {
      <span>Save Charge</span>
    }
  </button>
</div>
