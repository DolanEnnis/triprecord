<div class="trip-confirmation-container">
  <div class="header">
    <h1>Trip Confirmation</h1>
    <div class="spacer"></div>
    <button mat-flat-button color="accent" (click)="repairLegacyData()" style="margin-right: 8px;">
      <mat-icon>build</mat-icon> Repair Legacy Data
    </button>
    <button mat-icon-button (click)="showHelp()" matTooltip="Show help">
      <mat-icon>help_outline</mat-icon>
    </button>
  </div>

  <div class="controls-container">
    <mat-form-field appearance="outline">
      <mat-label>Filter Trips</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Search by ship, port, pilot..." #input>
    </mat-form-field>

    <div class="spacer"></div>

    <mat-button-toggle-group [value]="directionFilter()" (valueChange)="onDirectionChange($event)" aria-label="Filter by direction">
      <mat-button-toggle value="All">All</mat-button-toggle>
      <mat-button-toggle value="In">In</mat-button-toggle>
      <mat-button-toggle value="Out">Out</mat-button-toggle>
    </mat-button-toggle-group>

    <mat-button-toggle-group [value]="pilotFilter()" (valueChange)="onPilotFilterChange($event)" aria-label="Filter by pilot">
      <mat-button-toggle value="All">All Trips</mat-button-toggle>
      <mat-button-toggle value="My">{{ userName() }} Trips</mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Show a spinner while the initial data is loading -->
  @if (isLoading()) {
    <div class="spinner-container"><mat-progress-spinner mode="indeterminate"></mat-progress-spinner></div>
  } @else {
    <div class="table-container mat-elevation-z8">
      <table mat-table [dataSource]="dataSource" matSort matSortActive="boarding" matSortDirection="desc" class="mat-table">

        <!-- Ship Column -->
        <ng-container matColumnDef="ship">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Ship</th>
          <td mat-cell *matCellDef="let element">{{ element.ship }}</td>
        </ng-container>

        <!-- GT Column -->
        <ng-container matColumnDef="gt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>GT</th>
          <td mat-cell *matCellDef="let element">{{ element.gt | number }}</td>
        </ng-container>

        <!-- Date Column -->
        <ng-container matColumnDef="boarding">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Boarding Date</th>
          <td mat-cell *matCellDef="let element">{{ element.boarding | date:'dd-MM-yy' }}</td>
        </ng-container>

        <ng-container matColumnDef="typeTrip">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let element">{{ element.typeTrip }}</td>
        </ng-container>

        <!-- Port Column -->
        <ng-container matColumnDef="port">
          <th mat-header-cell *matHeaderCellDef>To/From</th>
          <td mat-cell *matCellDef="let element">{{ element.port }}</td>
        </ng-container>

        <!-- Extra Column -->
        <ng-container matColumnDef="extra">
          <th mat-header-cell *matHeaderCellDef>Extras</th>
          <td mat-cell *matCellDef="let element">{{ element.extra }}</td>
        </ng-container>

        <!-- Pilot No Column (No Header) -->
        <ng-container matColumnDef="pilotNo">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">{{ element.pilotNo }}</td>
        </ng-container>

        <!-- Month No Column (No Header) -->
        <ng-container matColumnDef="monthNo">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">{{ element.monthNo }}</td>
        </ng-container>

        <!-- Pilot Column -->
        <ng-container matColumnDef="pilot">
          <th mat-header-cell *matHeaderCellDef>Pilot</th>
          <td mat-cell *matCellDef="let element">{{ element.pilot }}</td>
        </ng-container>

        <!-- Note Column -->
        <ng-container matColumnDef="sailingNote">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Note</th>
          <td mat-cell *matCellDef="let element">
            @if (element.dataWarnings && element.dataWarnings.length > 0) {
              <div class="data-warnings">
                @for (warning of element.dataWarnings; track warning) {
                  <div class="warning-text">{{ warning }}</div>
                }
              </div>
            }
            {{ element.sailingNote }}
          </td>
        </ng-container>

        <!-- Docket Column -->
        <ng-container matColumnDef="docket">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element" class="docket-cell">
            @if (element.docketUrl) {
              <mat-icon 
                class="docket-indicator" 
                [matTooltip]="'Attached ' + (element.docketType === 'image' ? 'photo' : 'PDF')"
              >attach_file</mat-icon>
            }
          </td>
        </ng-container>

        <!-- Update Time Column -->
        <ng-container matColumnDef="metadata">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="updateTime" class="metadata-cell">Last Update</th>
          <td mat-cell *matCellDef="let element" class="metadata-cell">
            <div>{{ element.updatedBy }} ({{ element.source }})</div>
            <div>{{ element.updateTime | date : "dd-MM-yy HH:mm" }}</div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="onRowClicked(row)" [ngClass]="{
          'confirmed-row': !row.isActionable,
          'editable-row': !row.isActionable && isOwnTrip(row)
        }" class="data-row"></tr>

        <tr class="mat-row" *matNoDataRow><td class="mat-cell" [attr.colspan]="displayedColumns.length">No trips match your filter criteria.</td></tr>
      </table>
    </div>

    <!-- Actions for the table, like exporting -->
    <div class="footer-actions">
      <button mat-stroked-button (click)="exportConfirmedTripsToCsv()" matTooltip="Export confirmed trips from the current view to a CSV file">
        <mat-icon>download</mat-icon>
        Export Confirmed
      </button>
    </div>
  }
</div>

<button mat-flat-button class="fab-add-trip" (click)="openNewChargeDialog()" matTooltip="Create a new Trip from scratch">
  New Trip
</button>

@if (showHelpPopup()) {
  <app-help-popup (close)="closeHelp()"></app-help-popup>
}
