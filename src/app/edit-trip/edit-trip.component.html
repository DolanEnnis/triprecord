<div class="container" *ngIf="!loading(); else loader">
  <div class="header">
    <button mat-icon-button (click)="cancel()" matTooltip="Go back">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2>Edit Visit</h2>
  </div>

  <!-- OLD TRIP WARNING BANNER -->
  <div *ngIf="isOldTrip()" class="old-trip-warning">
    <mat-icon>warning</mat-icon>
    <div class="warning-content">
      <strong>Warning: This trip is {{ tripAgeDays() }} days old</strong>
      <p>Editing trips older than 60 days is discouraged. Historical records should generally remain unchanged.</p>
    </div>
  </div>

  <form [formGroup]="form" class="edit-form">
    
    <!-- SHIP INFO -->
    <mat-card class="section-card" formGroupName="ship">
      <mat-card-header>
        <mat-card-title>Ship Details</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Ship Name</mat-label>
          <input matInput formControlName="shipName" placeholder="e.g. MAERSK SHANNON">
          <mat-error *ngIf="form.get('ship.shipName')?.hasError('required')">Ship Name is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Gross Tonnage</mat-label>
          <input matInput type="number" formControlName="grossTonnage">
          <mat-error *ngIf="form.get('ship.grossTonnage')?.hasError('required')">Gross Tonnage is required</mat-error>
          <mat-error *ngIf="form.get('ship.grossTonnage')?.hasError('min')">Min value is 50</mat-error>
          <mat-error *ngIf="form.get('ship.grossTonnage')?.hasError('max')">Max value is 200,000</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>IMO Number</mat-label>
          <input matInput type="number" formControlName="imoNumber">
          <!-- TODO: AI Ship Intelligence Feature - Currently disabled
               Attempted implementations with Gemini API and OpenAI GPT (3.5-turbo, 4o, 4o-mini, 5.1-chat-latest)
               all failed due to lack of web browsing capabilities in API mode, resulting in hallucinations or null data.
               Future options: MarineTraffic API, VesselFinder API, or other maritime database services.
          <button mat-icon-button matSuffix (click)="fetchShipInfo()" [disabled]="fetchLoading()" matTooltip="Fetch Ship Info from AI">
            <mat-icon *ngIf="!fetchLoading()">auto_awesome</mat-icon>
            <mat-icon *ngIf="fetchLoading()" class="spin">sync</mat-icon>
          </button>
          -->
          <mat-error *ngIf="form.get('ship.imoNumber')?.hasError('min') || form.get('ship.imoNumber')?.hasError('max')">IMO must be 7 digits</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Marine Traffic Link</mat-label>
          <input matInput formControlName="marineTrafficLink" #mtLink>
          <a mat-icon-button matSuffix [href]="mtLink.value" target="_blank" *ngIf="mtLink.value" title="Open Link">
            <mat-icon>open_in_new</mat-icon>
          </a>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Ship Notes</mat-label>
          <textarea matInput formControlName="shipNotes" rows="2"></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- VISIT INFO -->
    <mat-card class="section-card" [class.highlighted]="shouldHighlightVisitStatus()" formGroupName="visit">
      <mat-card-header>
        <mat-card-title>Visit Status</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Current Status</mat-label>
          <mat-select formControlName="currentStatus">
            <mat-option *ngFor="let status of visitStatuses" [value]="status">
              {{ status }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('visit.currentStatus')?.hasError('required')">Status is required</mat-error>
        </mat-form-field>

        <app-date-time-picker formControlName="initialEta" class="span-2"></app-date-time-picker>

        <mat-form-field appearance="outline">
          <mat-label>Berth / Port</mat-label>
          <mat-select formControlName="berthPort">
            <mat-option *ngFor="let port of ports" [value]="port">
              {{ port }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="source-field">
          <mat-label>Source</mat-label>
          <mat-select formControlName="source">
            <mat-option *ngFor="let src of sources" [value]="src">
              {{ src }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Visit Notes</mat-label>
          <textarea matInput formControlName="visitNotes" rows="2"></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- INWARD TRIP -->
    <mat-card class="section-card" [class.highlighted]="shouldHighlightInwardTrip()" formGroupName="inwardTrip">
      <mat-card-header>
        <mat-card-title>Inward Trip</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Pilot</mat-label>
          <input 
            matInput 
            formControlName="pilot"
            [matAutocomplete]="inwardPilotAuto"
            (input)="onInwardPilotInput($any($event.target).value)">
          <mat-autocomplete #inwardPilotAuto="matAutocomplete">
            @for (pilot of filteredInwardPilots(); track pilot) {
              <mat-option [value]="pilot === 'Unassigned' ? '' : pilot">
                {{ pilot }}
              </mat-option>
            }
          </mat-autocomplete>
          <mat-error *ngIf="form.get('inwardTrip.pilot')?.hasError('invalidPilot')">
            Please select a valid pilot from the list
          </mat-error>
        </mat-form-field>

        <app-date-time-picker formControlName="boarding" class="span-2"></app-date-time-picker>

        <mat-form-field appearance="outline">
          <mat-label>Destination Port</mat-label>
          <mat-select formControlName="port">
            <mat-option *ngFor="let port of ports" [value]="port">
              {{ port }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Pilot Notes</mat-label>
          <textarea matInput formControlName="pilotNotes" rows="2"></textarea>
        </mat-form-field>

        <!-- PILOT'S OWN INFO - Only visible to assigned pilot -->
        <div *ngIf="isCurrentUserInwardPilot()" class="pilot-own-section">
          <h4 class="pilot-section-title">Pilot's Own Info</h4>
          
          <!-- Extra and Own Note - Full width, NOT in grid -->
          <mat-form-field appearance="outline" style="width: 100% !important; max-width: none !important; display: block; margin-bottom: 16px;">
            <mat-label>Extra</mat-label>
            <textarea matInput formControlName="extraChargesNotes" rows="2"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" style="width: 100% !important; max-width: none !important; display: block; margin-bottom: 16px;">
            <mat-label>Own Note</mat-label>
            <textarea matInput formControlName="ownNote" rows="2"></textarea>
          </mat-form-field>

          <!-- Pilot No, Month No, Good on one line -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
            <mat-form-field appearance="outline">
              <mat-label>Pilot No</mat-label>
              <input matInput type="number" formControlName="pilotNo">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Month No</mat-label>
              <input matInput type="number" formControlName="monthNo">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Good (1-6)</mat-label>
              <input matInput type="number" formControlName="good" min="1" max="6">
            </mat-form-field>
          </div>

          <!-- Car and Time Off on one line -->
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px;">
            <mat-form-field appearance="outline">
              <mat-label>Car</mat-label>
              <input matInput formControlName="car">
            </mat-form-field>

            <app-date-time-picker formControlName="timeOff" label="Time Off"></app-date-time-picker>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- OUTWARD TRIP -->
    <mat-card class="section-card" [class.highlighted]="shouldHighlightOutwardTrip()" formGroupName="outwardTrip">
      <mat-card-header>
        <mat-card-title>Outward Trip</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Pilot</mat-label>
          <input 
            matInput 
            formControlName="pilot"
            [matAutocomplete]="outwardPilotAuto"
            (input)="onOutwardPilotInput($any($event.target).value)">
          <mat-autocomplete #outwardPilotAuto="matAutocomplete">
            @for (pilot of filteredOutwardPilots(); track pilot) {
              <mat-option [value]="pilot === 'Unassigned' ? '' : pilot">
                {{ pilot }}
              </mat-option>
            }
          </mat-autocomplete>
          <mat-error *ngIf="form.get('outwardTrip.pilot')?.hasError('invalidPilot')">
            Please select a valid pilot from the list
          </mat-error>
        </mat-form-field>

        <app-date-time-picker formControlName="boarding" class="span-2"></app-date-time-picker>

        <mat-form-field appearance="outline">
          <mat-label>Origin Port</mat-label>
          <mat-select formControlName="port">
            <mat-option *ngFor="let port of ports" [value]="port">
              {{ port }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Pilot Notes</mat-label>
          <textarea matInput formControlName="pilotNotes" rows="2"></textarea>
        </mat-form-field>

        <!-- PILOT'S OWN INFO - Only visible to assigned pilot -->
        <div *ngIf="isCurrentUserOutwardPilot()" class="pilot-own-section">
          <h4 class="pilot-section-title">Pilot's Own Info</h4>
          
          <!-- Extra and Own Note - Full width, NOT in grid -->
          <mat-form-field appearance="outline" style="width: 100% !important; max-width: none !important; display: block; margin-bottom: 16px;">
            <mat-label>Extra</mat-label>
            <textarea matInput formControlName="extraChargesNotes" rows="2"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" style="width: 100% !important; max-width: none !important; display: block; margin-bottom: 16px;">
            <mat-label>Own Note</mat-label>
            <textarea matInput formControlName="ownNote" rows="2"></textarea>
          </mat-form-field>

          <!-- Pilot No, Month No, Good on one line -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
            <mat-form-field appearance="outline">
              <mat-label>Pilot No</mat-label>
              <input matInput type="number" formControlName="pilotNo">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Month No</mat-label>
              <input matInput type="number" formControlName="monthNo">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Good (1-6)</mat-label>
              <input matInput type="number" formControlName="good" min="1" max="6">
            </mat-form-field>
          </div>

          <!-- Car and Time Off on one line -->
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px;">
            <mat-form-field appearance="outline">
              <mat-label>Car</mat-label>
              <input matInput formControlName="car">
            </mat-form-field>

            <app-date-time-picker formControlName="timeOff" label="Time Off"></app-date-time-picker>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ADDITIONAL TRIPS -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>Additional Trips</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        
        <div formArrayName="additionalTrips">
          @if (additionalTripsArray.length === 0) {
            <p class="empty-state">No additional trips. Click "Add Trip" to create one.</p>
          }

          @for (trip of additionalTripsArray.controls; track trip; let i = $index) {
            <div [formGroupName]="i" class="additional-trip-card">
              <div class="trip-header">
                <h3>Trip {{ i + 1 }}</h3>
                <button mat-icon-button color="warn" (click)="removeTrip(i)" type="button" matTooltip="Delete this trip">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div class="form-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Trip Type</mat-label>
                  <mat-select formControlName="typeTrip">
                    @for (type of additionalTripTypes; track type) {
                      <mat-option [value]="type">{{ type }}</mat-option>
                    }
                  </mat-select>
                  <mat-error *ngIf="trip.get('typeTrip')?.hasError('required')">
                    Trip type is required
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Pilot</mat-label>
                  <input 
                    matInput 
                    formControlName="pilot"
                    [matAutocomplete]="auto">
                  <mat-autocomplete #auto="matAutocomplete">
                    @for (pilot of pilotService.pilotNames(); track pilot) {
                      <mat-option [value]="pilot">{{ pilot }}</mat-option>
                    }
                    <mat-option value="">Unassigned</mat-option>
                  </mat-autocomplete>
                  <mat-error *ngIf="trip.get('pilot')?.hasError('required')">
                    Pilot is required
                  </mat-error>
                  <mat-error *ngIf="trip.get('pilot')?.hasError('invalidPilot')">
                    Please select a valid pilot
                  </mat-error>
                </mat-form-field>

                <app-date-time-picker formControlName="boarding" class="span-2"></app-date-time-picker>

                <mat-form-field appearance="outline">
                  <mat-label>Port</mat-label>
                  <mat-select formControlName="port">
                    @for (port of ports; track port) {
                      <mat-option [value]="port">{{ port }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Pilot Notes</mat-label>
                  <textarea matInput formControlName="pilotNotes" rows="2"></textarea>
                </mat-form-field>
              </div>
            </div>
          }
        </div>

        <!-- Tooltip wrapper needed because disabled buttons don't receive mouse events -->
        <div 
          class="add-trip-button-wrapper"
          [matTooltip]="hasUnsavedAdditionalTrip ? 'Please save before adding another trip' : 'Add a new additional trip'">
          <button 
            mat-raised-button 
            color="accent" 
            (click)="addTrip()" 
            type="button" 
            class="add-trip-btn"
            [disabled]="hasUnsavedAdditionalTrip">
            <mat-icon>add</mat-icon>
            Add Trip
          </button>
        </div>

      </mat-card-content>
    </mat-card>

  </form>

  <!-- 
    Floating Action Buttons with Tooltip Wrapper 
    
    DESIGN PATTERN: Wrapper-based tooltip for disabled buttons
    - matTooltip on wrapper instead of button (disabled buttons don't receive mouse events)
    - Dynamic tooltip shows validation errors or save status
    - Maintains FAB (Floating Action Button) position and styling
    
    UX IMPROVEMENT: Cancel button added
    - Users can easily exit without saving
    - Natural navigation pattern (back to where they came from)
    - Reduces confusion when "Save Changes" is the only option
  -->
  <div class="fab-buttons">
    <!-- Cancel Button -->
    <button 
      mat-fab 
      color="basic" 
      class="fab-cancel" 
      (click)="cancel()"
      matTooltip="Go back without saving">
      <mat-icon>close</mat-icon>
    </button>
    
    <!-- Save Button -->
    <div [matTooltip]="getSaveButtonTooltip()" class="fab-wrapper">
      <button 
        mat-extended-fab 
        color="primary" 
        class="fab-save" 
        (click)="save()" 
        [disabled]="saving()">
        <mat-icon>save</mat-icon>
        <span>{{ saving() ? 'Saving...' : 'Save Changes' }}</span>
      </button>
    </div>
  </div>
</div>

<ng-template #loader>
  <div class="loader-container">
    <p>Loading visit details...</p>
  </div>
</ng-template>
