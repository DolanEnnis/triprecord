<div class="container" *ngIf="!loading(); else loader">
  <div class="header">
    <h2>Edit Visit</h2>
  </div>

  <form [formGroup]="form" class="edit-form">
    
    <!-- SHIP INFO -->
    <mat-card class="section-card" formGroupName="ship">
      <mat-card-header>
        <mat-card-title>Ship Details</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Ship Name</mat-label>
          <input matInput formControlName="shipName" placeholder="e.g. MAERSK SHANNON">
          <mat-error *ngIf="form.get('ship.shipName')?.hasError('required')">Ship Name is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Gross Tonnage</mat-label>
          <input matInput type="number" formControlName="grossTonnage">
          <mat-error *ngIf="form.get('ship.grossTonnage')?.hasError('required')">Gross Tonnage is required</mat-error>
          <mat-error *ngIf="form.get('ship.grossTonnage')?.hasError('min')">Min value is 50</mat-error>
          <mat-error *ngIf="form.get('ship.grossTonnage')?.hasError('max')">Max value is 200,000</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>IMO Number</mat-label>
          <input matInput type="number" formControlName="imoNumber">
          <!-- TODO: AI Ship Intelligence Feature - Currently disabled
               Attempted implementations with Gemini API and OpenAI GPT (3.5-turbo, 4o, 4o-mini, 5.1-chat-latest)
               all failed due to lack of web browsing capabilities in API mode, resulting in hallucinations or null data.
               Future options: MarineTraffic API, VesselFinder API, or other maritime database services.
          <button mat-icon-button matSuffix (click)="fetchShipInfo()" [disabled]="fetchLoading()" matTooltip="Fetch Ship Info from AI">
            <mat-icon *ngIf="!fetchLoading()">auto_awesome</mat-icon>
            <mat-icon *ngIf="fetchLoading()" class="spin">sync</mat-icon>
          </button>
          -->
          <mat-error *ngIf="form.get('ship.imoNumber')?.hasError('min') || form.get('ship.imoNumber')?.hasError('max')">IMO must be 7 digits</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Marine Traffic Link</mat-label>
          <input matInput formControlName="marineTrafficLink" #mtLink>
          <a mat-icon-button matSuffix [href]="mtLink.value" target="_blank" *ngIf="mtLink.value" title="Open Link">
            <mat-icon>open_in_new</mat-icon>
          </a>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Ship Notes</mat-label>
          <textarea matInput formControlName="shipNotes" rows="2"></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- VISIT INFO -->
    <mat-card class="section-card" formGroupName="visit">
      <mat-card-header>
        <mat-card-title>Visit Status</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Current Status</mat-label>
          <mat-select formControlName="currentStatus">
            <mat-option *ngFor="let status of visitStatuses" [value]="status">
              {{ status }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('visit.currentStatus')?.hasError('required')">Status is required</mat-error>
        </mat-form-field>

        <app-date-time-picker formControlName="initialEta" class="span-2"></app-date-time-picker>

        <mat-form-field appearance="outline">
          <mat-label>Berth / Port</mat-label>
          <mat-select formControlName="berthPort">
            <mat-option *ngFor="let port of ports" [value]="port">
              {{ port }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Source</mat-label>
          <mat-select formControlName="source">
            <mat-option *ngFor="let src of sources" [value]="src">
              {{ src }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Visit Notes</mat-label>
          <textarea matInput formControlName="visitNotes" rows="2"></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- INWARD TRIP -->
    <mat-card class="section-card" formGroupName="inwardTrip">
      <mat-card-header>
        <mat-card-title>Inward Trip</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Pilot</mat-label>
          <input 
            matInput 
            formControlName="pilot"
            [matAutocomplete]="inwardPilotAuto"
            (input)="onInwardPilotInput($any($event.target).value)">
          <mat-autocomplete #inwardPilotAuto="matAutocomplete">
            @for (pilot of filteredInwardPilots(); track pilot) {
              <mat-option [value]="pilot === 'Unassigned' ? '' : pilot">
                {{ pilot }}
              </mat-option>
            }
          </mat-autocomplete>
          <mat-error *ngIf="form.get('inwardTrip.pilot')?.hasError('invalidPilot')">
            Please select a valid pilot from the list
          </mat-error>
        </mat-form-field>

        <app-date-time-picker formControlName="boarding" class="span-2"></app-date-time-picker>

        <mat-form-field appearance="outline">
          <mat-label>Destination Port</mat-label>
          <mat-select formControlName="port">
            <mat-option *ngFor="let port of ports" [value]="port">
              {{ port }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Pilot Notes</mat-label>
          <textarea matInput formControlName="pilotNotes" rows="2"></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- OUTWARD TRIP -->
    <mat-card class="section-card" formGroupName="outwardTrip">
      <mat-card-header>
        <mat-card-title>Outward Trip</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Pilot</mat-label>
          <input 
            matInput 
            formControlName="pilot"
            [matAutocomplete]="outwardPilotAuto"
            (input)="onOutwardPilotInput($any($event.target).value)">
          <mat-autocomplete #outwardPilotAuto="matAutocomplete">
            @for (pilot of filteredOutwardPilots(); track pilot) {
              <mat-option [value]="pilot === 'Unassigned' ? '' : pilot">
                {{ pilot }}
              </mat-option>
            }
          </mat-autocomplete>
          <mat-error *ngIf="form.get('outwardTrip.pilot')?.hasError('invalidPilot')">
            Please select a valid pilot from the list
          </mat-error>
        </mat-form-field>

        <app-date-time-picker formControlName="boarding" class="span-2"></app-date-time-picker>

        <mat-form-field appearance="outline">
          <mat-label>Origin Port</mat-label>
          <mat-select formControlName="port">
            <mat-option *ngFor="let port of ports" [value]="port">
              {{ port }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Pilot Notes</mat-label>
          <textarea matInput formControlName="pilotNotes" rows="2"></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- ADDITIONAL TRIPS -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>Additional Trips</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        
        <div formArrayName="additionalTrips">
          @if (additionalTripsArray.length === 0) {
            <p class="empty-state">No additional trips. Click "Add Trip" to create one.</p>
          }

          @for (trip of additionalTripsArray.controls; track trip; let i = $index) {
            <div [formGroupName]="i" class="additional-trip-card">
              <div class="trip-header">
                <h3>Trip {{ i + 1 }}</h3>
                <button mat-icon-button color="warn" (click)="removeTrip(i)" type="button" matTooltip="Delete this trip">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div class="form-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Trip Type</mat-label>
                  <mat-select formControlName="typeTrip">
                    @for (type of additionalTripTypes; track type) {
                      <mat-option [value]="type">{{ type }}</mat-option>
                    }
                  </mat-select>
                  <mat-error *ngIf="trip.get('typeTrip')?.hasError('required')">
                    Trip type is required
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Pilot</mat-label>
                  <input 
                    matInput 
                    formControlName="pilot"
                    [matAutocomplete]="auto">
                  <mat-autocomplete #auto="matAutocomplete">
                    @for (pilot of pilotService.pilotNames(); track pilot) {
                      <mat-option [value]="pilot">{{ pilot }}</mat-option>
                    }
                    <mat-option value="">Unassigned</mat-option>
                  </mat-autocomplete>
                  <mat-error *ngIf="trip.get('pilot')?.hasError('required')">
                    Pilot is required
                  </mat-error>
                  <mat-error *ngIf="trip.get('pilot')?.hasError('invalidPilot')">
                    Please select a valid pilot
                  </mat-error>
                </mat-form-field>

                <app-date-time-picker formControlName="boarding" class="span-2"></app-date-time-picker>

                <mat-form-field appearance="outline">
                  <mat-label>Port</mat-label>
                  <mat-select formControlName="port">
                    @for (port of ports; track port) {
                      <mat-option [value]="port">{{ port }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Pilot Notes</mat-label>
                  <textarea matInput formControlName="pilotNotes" rows="2"></textarea>
                </mat-form-field>
              </div>
            </div>
          }
        </div>

        <!-- Tooltip wrapper needed because disabled buttons don't receive mouse events -->
        <div 
          class="add-trip-button-wrapper"
          [matTooltip]="hasUnsavedAdditionalTrip ? 'Please save before adding another trip' : 'Add a new additional trip'">
          <button 
            mat-raised-button 
            color="accent" 
            (click)="addTrip()" 
            type="button" 
            class="add-trip-btn"
            [disabled]="hasUnsavedAdditionalTrip">
            <mat-icon>add</mat-icon>
            Add Trip
          </button>
        </div>

      </mat-card-content>
    </mat-card>

  </form>

  <!-- Floating Save Button -->
  <button 
    mat-extended-fab 
    color="primary" 
    class="fab-save" 
    (click)="save()" 
    [disabled]="saving()"
    matTooltip="Save all changes">
    <mat-icon>save</mat-icon>
    <span>{{ saving() ? 'Saving...' : 'Save Changes' }}</span>
  </button>
</div>

<ng-template #loader>
  <div class="loader-container">
    <p>Loading visit details...</p>
  </div>
</ng-template>
