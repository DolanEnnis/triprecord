<div class="new-visit-container">
  <mat-card class="main-card">
    <mat-card-header>
      <mat-card-title>
        <h2>New Vessel Visit</h2>
      </mat-card-title>
      <mat-card-subtitle>Record a vessel arriving into the river.</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="content-flex-container">

      <div class="form-section">
        <form [formGroup]="visitForm" (ngSubmit)="onSubmit()">
          <h3 color="primary">Vessel Details</h3>
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Ship Name</mat-label>
              <input matInput formControlName="shipName" [matAutocomplete]="autoShip" (blur)="onShipNameBlur()" required>
              <mat-autocomplete #autoShip="matAutocomplete" [displayWith]="displayShip" (optionSelected)="onShipSelected($event)">
                @for (ship of filteredShips$ | async; track ship.id) {
                  <mat-option [value]="ship">{{ ship.ship }} ({{ ship.gt | number }})</mat-option>
                }
              </mat-autocomplete>
              @if (shipNameControl.hasError('required') && shipNameControl.touched) {
                <mat-error>Ship name is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Gross Tonnage (GT)</mat-label>
              <input matInput type="number" formControlName="grossTonnage" required>
              @if (grossTonnageControl.hasError('required') && grossTonnageControl.touched) {
                <mat-error>GT is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>IMO Number</mat-label>
              <input matInput type="number" formControlName="imoNumber">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Marine Traffic URL</mat-label>
              <input matInput type="url" formControlName="marineTrafficLink">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Vessel Notes / Characteristics</mat-label>
              <textarea matInput formControlName="shipNotes" rows="2"></textarea>
            </mat-form-field>
          </div>

          <h3 color="primary">Visit & Initial Trip Details</h3>
          <div class="form-grid">

            <!--<mat-form-field appearance="outline" class="datetime-picker-field">
              <mat-label>Initial ETA (Date and Time)</mat-label>
              <input matInput [ngxMatDatetimePicker]="picker" formControlName="initialEta" [min]="minDate" required>

              <mat-icon-button matSuffix [ngxDatetimePickerToggle]="picker">
                <mat-icon>calendar_today</mat-icon>
              </mat-icon-button>

              <ngx-mat-datetime-picker #picker [showSpinners]="true" [showSeconds]="false" [stepHour]="1"
                                       [stepMinute]="5" [touchUi]="false" [color]="'primary'">
              </ngx-mat-datetime-picker>

              @if (visitForm.get('initialEta')?.hasError('required') && visitForm.get('initialEta')?.touched) {
                <mat-error>Date and Time are required</mat-error>
              }
            </mat-form-field>-->

            <mat-form-field appearance="outline">
              <mat-label>Destination Port</mat-label>
              <mat-select formControlName="berthPort" required>
                @for (port of ports; track port) {
                  <mat-option [value]="port">{{ port }}</mat-option>
                }
              </mat-select>
              @if (visitForm.get('berthPort')?.hasError('required') && visitForm.get('berthPort')?.touched) {
                <mat-error>Destination is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Initial Pilot (Inward Trip)</mat-label>
              <input matInput formControlName="pilot" required>
              @if (visitForm.get('pilot')?.hasError('required') && visitForm.get('pilot')?.touched) {
                <mat-error>Pilot is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Visit Notes (Initial reason, issues, etc.)</mat-label>
              <textarea matInput formControlName="visitNotes" rows="2"></textarea>
            </mat-form-field>
          </div>
        </form>
      </div>

      @if (previousVisits().length > 0) {
        <mat-divider [vertical]="true"></mat-divider>
        <div class="visits-section">
          <h3 color="primary" class="visits-header">Previous Visits ({{ previousVisits().length }} Total)</h3>

          <a href="http://www.cargopro.ie/sfpc/download/rpt_daydiary.pdf" target="_blank">Open Day Diary</a>

          <ul class="visit-list">
            @for (visit of previousVisits().slice(0, 5); track visit.id) {
              <li>
                <div class="visit-details">
                  <span class="visit-date">Date: {{ visit.initialEta.toDate() | date:'dd/MM/yy HH:mm' }}</span>
                  <span class="visit-port">Port: {{ visit.berthPort || 'N/A' }}</span>
                  <span class="visit-status">Status: {{ visit.currentStatus }}</span>
                </div>
                @if (visit.visitNotes) {
                  <p class="visit-note">Note: {{ visit.visitNotes }}</p>
                }
              </li>
            }
            @if (previousVisits().length > 5) {
              <li class="more-visits">... and {{ previousVisits().length - 5 }} more.</li>
            }
          </ul>
        </div>
      }
    </mat-card-content>

    <mat-card-actions align="end">
      <a mat-button color="accent" routerLink="/trip-confirmation">Cancel</a>
      <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="visitForm.invalid || isLoading">
        @if (isLoading) {
          <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
        } @else {
          <span>Create Visit</span>
        }
      </button>
    </mat-card-actions>
  </mat-card>
</div>
