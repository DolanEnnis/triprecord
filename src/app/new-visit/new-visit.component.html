<div class="new-visit-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <h2>New Vessel Visit</h2>
      </mat-card-title>
      <mat-card-subtitle>Record a vessel arriving into the river.</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="visitForm" (ngSubmit)="onSubmit()">
        <h3 color="primary">Vessel Details</h3>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Ship Name</mat-label>
            <input matInput formControlName="shipName" [matAutocomplete]="autoShip" required>
            <mat-autocomplete #autoShip="matAutocomplete" [displayWith]="displayShip" (optionSelected)="onShipSelected($event)">
              @for (ship of filteredShips$ | async; track ship.id) {
                <mat-option [value]="ship">{{ ship.ship }} ({{ ship.gt | number }})</mat-option>
              }
            </mat-autocomplete>
            @if (shipNameControl.hasError('required') && shipNameControl.touched) {
              <mat-error>Ship name is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Gross Tonnage (GT)</mat-label>
            <input matInput type="number" formControlName="grossTonnage" required>
            @if (grossTonnageControl.hasError('required') && grossTonnageControl.touched) {
              <mat-error>GT is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>IMO Number</mat-label>
            <input matInput type="number" formControlName="imoNumber">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Marine Traffic Link</mat-label>
            <input matInput type="url" formControlName="marineTrafficLink">
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Vessel Notes / Characteristics</mat-label>
            <textarea matInput formControlName="shipNotes" rows="2"></textarea>
          </mat-form-field>
        </div>

        <h3 color="primary">Visit & Initial Trip Details</h3>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Initial ETA (Date/Time)</mat-label>
            <input matInput [matDatepicker]="etaPicker" formControlName="initialEta" [min]="minDate" required>
            <mat-datepicker-toggle matIconSuffix [for]="etaPicker"></mat-datepicker-toggle>
            <mat-datepicker #etaPicker></mat-datepicker>
            @if (visitForm.get('initialEta')?.hasError('required') && visitForm.get('initialEta')?.touched) {
              <mat-error>ETA is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Destination Port</mat-label>
            <mat-select formControlName="berthPort" required>
              @for (port of ports; track port) {
                <mat-option [value]="port">{{ port }}</mat-option>
              }
            </mat-select>
            @if (visitForm.get('berthPort')?.hasError('required') && visitForm.get('berthPort')?.touched) {
              <mat-error>Destination is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Initial Pilot (Inward Trip)</mat-label>
            <input matInput formControlName="pilot" required>
            @if (visitForm.get('pilot')?.hasError('required') && visitForm.get('pilot')?.touched) {
              <mat-error>Pilot is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Visit Notes (Initial reason, issues, etc.)</mat-label>
            <textarea matInput formControlName="visitNotes" rows="2"></textarea>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>

    @if (previousVisits().length > 0) {
      <mat-divider></mat-divider>
      <mat-card-content class="previous-visits-section">
        <h3 color="primary">Previous Visits ({{ previousVisits().length }} Total)</h3>
        <ul class="visit-list">
          @for (visit of previousVisits().slice(0, 5); track visit.id) {
            <li>
              <div class="visit-details">
                <span class="visit-date">Date: {{ visit.initialEta.toDate() | date:'dd-MM-yyyy' }}</span>
                <span class="visit-port">Port: {{ visit.berthPort || 'N/A' }}</span>
                <span class="visit-status">Status: {{ visit.currentStatus }}</span>
              </div>
              @if (visit.visitNotes) {
                <p class="visit-note">Note: {{ visit.visitNotes }}</p>
              }
            </li>
          }
          @if (previousVisits().length > 5) {
            <li class="more-visits">... and {{ previousVisits().length - 5 }} more.</li>
          }
        </ul>
      </mat-card-content>
    }

    <mat-card-actions align="end">
      <a mat-button color="accent" routerLink="/trip-confirmation">Cancel</a>
      <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="visitForm.invalid || isLoading">
        @if (isLoading) {
          <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
        } @else {
          <span>Create Visit</span>
        }
      </button>
    </mat-card-actions>
  </mat-card>
</div>
