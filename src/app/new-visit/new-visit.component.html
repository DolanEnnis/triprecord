<div class="new-visit-container">
  <mat-card class="main-card">
    <mat-card-header>
      <mat-card-title>
        <h2>New Vessel Visit</h2>
      </mat-card-title>
      <mat-card-subtitle>Record a vessel arriving into the river.</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="content-flex-container">

      <div class="form-section">
        <form [formGroup]="visitForm" (ngSubmit)="onSubmit()">
          <h3 color="primary">Vessel Details</h3>
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Ship Name</mat-label>
              <input matInput formControlName="shipName" [matAutocomplete]="autoShip" (blur)="onShipNameBlur()" required>
              <mat-autocomplete #autoShip="matAutocomplete" [displayWith]="displayShip" (optionSelected)="onShipSelected($event)">
                @for (ship of filteredShips$ | async; track ship.id) {
                  <mat-option [value]="ship">{{ ship.ship }} ({{ ship.gt | number }})</mat-option>
                }
              </mat-autocomplete>
              @if (shipNameControl.hasError('required') && shipNameControl.touched) {
                <mat-error>Ship name is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Gross Tonnage (GT)</mat-label>
              <input matInput type="number" formControlName="grossTonnage" required>
              @if (grossTonnageControl.hasError('required') && grossTonnageControl.touched) {
                <mat-error>GT is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>IMO Number</mat-label>
              <input matInput type="number" formControlName="imoNumber">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Marine Traffic URL</mat-label>
              <input matInput type="url" formControlName="marineTrafficLink">
              @if(visitForm.get('marineTrafficLink')?.value) {
                <a mat-icon-button matSuffix [href]="visitForm.get('marineTrafficLink')?.value" target="_blank"
                   aria-label="Open Marine Traffic link in a new tab">
                  <mat-icon>open_in_new</mat-icon>
                </a>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Vessel Notes / Characteristics</mat-label>
              <textarea matInput formControlName="shipNotes" rows="2"></textarea>
            </mat-form-field>
          </div>

          <h3 color="primary">Visit & Initial Trip Details</h3>
          <div class="form-grid">

            <app-date-time-picker formControlName="initialEta"></app-date-time-picker>

            <mat-form-field appearance="outline" class="grid-col-span-2">
              <mat-label>Destination Port</mat-label>
              <mat-select formControlName="berthPort" required>
                @for (port of ports; track port) {
                  <mat-option [value]="port">{{ port }}</mat-option>
                }
              </mat-select>
              @if (visitForm.get('berthPort')?.hasError('required') && visitForm.get('berthPort')?.touched) {
                <mat-error>Destination is required</mat-error>
              }
            </mat-form-field>

            <div class="notes-source-container full-width">
              <mat-form-field appearance="outline">
                <mat-label>Visit Notes</mat-label>
                <textarea matInput formControlName="visitNotes" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Updated From</mat-label>
                <mat-select formControlName="source" required>
                  @for (source of sources; track source) {
                    <mat-option [value]="source">{{ source }}</mat-option>
                  }
                </mat-select>
                @if (visitForm.get('source')?.hasError('required') && visitForm.get('source')?.touched) {
                  <mat-error>Source is required</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </form>
      </div>

      @if (previousVisits().length > 0) {
        <div class="visits-section">
          <h3 color="primary" class="visits-header">Previous Visits ({{ previousVisits().length }} Total)</h3>

          <div class="table-container mat-elevation-z8">
            <table mat-table [dataSource]="previousVisits()" class="mat-table">

              <!-- Date Column -->
              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let visit">{{ visit.initialEta.toDate() | date:'dd/MM/yy' }}</td>
              </ng-container>

              <!-- Port Column -->
              <ng-container matColumnDef="port">
                <th mat-header-cell *matHeaderCellDef>Port</th>
                <td mat-cell *matCellDef="let visit">{{ visit.berthPort || 'N/A' }}</td>
              </ng-container>

              <!-- Pilot Column -->
              <ng-container matColumnDef="pilot">
                <th mat-header-cell *matHeaderCellDef>Pilot</th>
                <td mat-cell *matCellDef="let visit">{{ visit.inwardPilot }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                  [class.active-visit]="isVisitActive(row)"
                  (click)="viewVisit(row)"
                  matTooltip="Click to view visit details"
                  class="clickable-row"></tr>

              <tr class="mat-row" *matNoDataRow><td class="mat-cell" [attr.colspan]="displayedColumns.length">No previous visits.</td></tr>
            </table>
          </div>
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- 
    Floating Action Buttons - Horizontal Layout
    
    DESIGN PATTERN: Cancel as text button beside primary action
    - Simple text button for Cancel (original design user preferred)
    - Primary action button (Create Visit) with tooltip wrapper for disabled state
    - Horizontal layout with buttons side-by-side
    - Fixed position at bottom-right, stays visible while scrolling
  -->
  <div class="fab-buttons">
    <!-- Cancel Button (text button, appears first/left) -->
    <button 
      mat-button 
      color="accent" 
      class="fab-cancel" 
      routerLink="/trip-confirmation">
      Cancel
    </button>
    
    <!-- Create Visit Button (primary action, appears second/right) -->
    <div [matTooltip]="getFormErrorTooltip()" class="fab-wrapper">
      <button 
        mat-flat-button
        class="fab-create" 
        (click)="onSubmit()" 
        [disabled]="visitForm.invalid || isLoading">
        @if (isLoading) {
          <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
        } @else {
          Create Visit
        }
      </button>
    </div>
  </div>
</div>
