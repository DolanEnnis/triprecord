<div class="reconciliation-container">
  <!-- PDF Daily Diary Section -->
  <mat-card class="pdf-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>picture_as_pdf</mat-icon>
        <a href="http://www.cargopro.ie/sfpc/download/rpt_daydiary.pdf" target="_blank" rel="noopener noreferrer">Day Diary PDF</a>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (pdfLoading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p class="loading-message">Working on Day Diary, Fetching the info for you, this can take a couple of Mins! Sorry!</p>
          @if (loadingStep()) {
            <p class="loading-step">{{ loadingStep() }}</p>
          }
        </div>
      }

      @if (pdfError()) {
        <div class="error-message">
          <mat-icon color="warn">error</mat-icon>
          <p>{{ pdfError() }}</p>
          <button mat-raised-button color="primary" (click)="fetchPdf()" class="retry-button">
            <mat-icon>refresh</mat-icon>
            Retry
          </button>
        </div>
      }

      @if (pdfShips().length > 0) {
        <div class="ships-section">
          <div class="ships-header">
            <h3>Extracted Ships ({{ pdfShipsCount() }})</h3>
            <div class="timestamp-container">
              @if (lastProcessed()) {
                <span class="last-updated">Last updated: {{ lastProcessed() | date:'dd/MM/yyyy HH:mm' }}</span>
              }
              @if (previousProcessed()) {
                <span class="previous-updated">Previous: {{ previousProcessed() | date:'dd/MM/yyyy HH:mm' }}</span>
              }
            </div>
          </div>
          <table mat-table [dataSource]="shipComparisons()" class="ships-table">
            
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Vessel Name</th>
              <td mat-cell *matCellDef="let comparison"
                  [class.new-ship]="comparison.changeType === 'new'"
                  [class.removed-ship]="comparison.changeType === 'removed'">
                <span [class.bold]="comparison.changedFields.has('name')">{{ comparison.ship.name }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="gt">
              <th mat-header-cell *matHeaderCellDef>GT</th>
              <td mat-cell *matCellDef="let comparison"
                  [class.new-ship]="comparison.changeType === 'new'"
                  [class.removed-ship]="comparison.changeType === 'removed'">
                <span [class.bold]="comparison.changedFields.has('gt')">{{ comparison.ship.gt | number }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="port">
              <th mat-header-cell *matHeaderCellDef>Port</th>
              <td mat-cell *matCellDef="let comparison"
                  [class.new-ship]="comparison.changeType === 'new'"
                  [class.removed-ship]="comparison.changeType === 'removed'">
                <span [class.bold]="comparison.changedFields.has('port')">{{ comparison.ship.port }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="notes">
              <th mat-header-cell *matHeaderCellDef>Notes</th>
              <td mat-cell *matCellDef="let comparison"
                  [class.new-ship]="comparison.changeType === 'new'"
                  [class.removed-ship]="comparison.changeType === 'removed'">
                <span [class.bold]="comparison.changedFields.has('notes')">
                  @if (comparison.ship.notes) {
                    {{ comparison.ship.notes }}
                  } @else {
                    -
                  }
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let comparison"
                  [class.new-ship]="comparison.changeType === 'new'"
                  [class.removed-ship]="comparison.changeType === 'removed'">
                <span [class.bold]="comparison.changedFields.has('status')">{{ comparison.ship.status }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="eta">
              <th mat-header-cell *matHeaderCellDef>Next Movement</th>
              <td mat-cell *matCellDef="let comparison"
                  [class.new-ship]="comparison.changeType === 'new'"
                  [class.removed-ship]="comparison.changeType === 'removed'">
                <span [class.bold]="comparison.changedFields.has('eta')">
                  @if (comparison.ship.eta) {
                    {{ comparison.ship.eta | date:'dd/MM HH:mm' }}
                  } @else {
                    -
                  }
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>

        <details class="raw-text-details">
          <summary class="raw-text-summary">Show Raw PDF Text</summary>
          <pre class="raw-text-content">{{ pdfText() }}</pre>
        </details>
      } @else if (pdfText()) {
        <div class="no-ships-section">
          <h3>PDF Content (Raw Text - No Ships Found)</h3>
          <pre class="raw-text-content raw-text-large">{{ pdfText() }}</pre>
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- PDF-ONLY SHIPS (Not in Our System) -->
  @if (pdfShips().length > 0 && pdfOnlyResults().length > 0) {
    <mat-card class="pdf-only-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon color="warn">add_circle_outline</mat-icon>
          Ships in PDF - Not in Our System ({{ pdfOnlyResults().length }})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table class="pdf-only-table">
          <thead>
            <tr>
              <th>Vessel Name</th>
              <th>GT</th>
              <th>Next Movement</th>
              <th>Port</th>
              <th>Notes</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            @for (result of pdfOnlyResults(); track result.shipName) {
              <tr>
                <td>{{ result.pdfShip!.name }}</td>
                <td>{{ result.pdfShip!.gt | number }}</td>
                <td>@if (result.pdfShip!.eta) { {{ result.pdfShip!.eta | date:'dd/MM HH:mm' }} } @else { - }</td>
                <td>{{ result.pdfShip!.port }}</td>
                <td>@if (result.pdfShip!.notes) { {{ result.pdfShip!.notes }} } @else { - }</td>
                <td>{{ result.pdfShip!.status }}</td>
                <td>
                  <button mat-raised-button color="primary" (click)="createVisitFromPdf(result.pdfShip!)">
                    <mat-icon>add</mat-icon>
                    Create Visit
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </mat-card-content>
    </mat-card>
  }

  <!-- SYSTEM-ONLY SHIPS (In Our System but Not in PDF) -->
  @if (pdfShips().length > 0 && systemOnlyResults().length > 0) {
    <mat-card class="system-only-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon color="accent">info_outline</mat-icon>
          In Our System - Not in PDF ({{ systemOnlyResults().length }})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p class="info-text">These ships are active in our system but don't appear in the PDF. They may have sailed, been cancelled, or the PDF may be outdated.</p>
        <table class="system-only-table">
          <thead>
            <tr>
              <th>Vessel Name</th>
              <th>GT</th>
              <th>Next Movement</th>
              <th>Port</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            @for (result of systemOnlyResults(); track result.shipName) {
              <tr>
                <td>{{ result.shipName }}</td>
                <td>{{ getSystemGt(result) | number }}</td>
                <td>{{ getSystemEta(result) | date:'dd/MM HH:mm' }}</td>
                <td>{{ getSystemPort(result) }}</td>
                <td>{{ getSystemStatus(result) }}</td>
              </tr>
            }
          </tbody>
        </table>
      </mat-card-content>
    </mat-card>
  }
</div>

