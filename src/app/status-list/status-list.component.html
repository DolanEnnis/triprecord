<div class="status-container">
  <!-- Port Filter -->
  <div class="filter-container">
    <mat-button-toggle-group
      [value]="portFilter()"
      (valueChange)="onPortFilterChange($event)"
      aria-label="Filter by port"
    >
      <mat-button-toggle value="All">All Ports</mat-button-toggle>
      <mat-button-toggle value="Aughinish">Aughinish</mat-button-toggle>
      <mat-button-toggle value="Foynes">Foynes</mat-button-toggle>
      <mat-button-toggle value="Limerick">Limerick</mat-button-toggle>
      <mat-button-toggle value="Other">Other</mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Dynamic Sections Loop - Single table definition for all sections -->
  <ng-container *ngFor="let section of sections()">
    <!-- Section Header -->
    @if (section.data.length > 0) {
      <div class="section-header">
        <h2>{{ section.title }}</h2>
      </div>
    }

    <!-- Empty State for Filtered View -->
    @if (section.data.length === 0 && portFilter() !== 'All') {
      <div class="empty-state">
        <p>No ships {{ section.title.toLowerCase() }} for {{ section.portFilterName }}</p>
      </div>
    }

    <!-- Data Table - Now defined ONCE instead of 3 times -->
    @if (section.data.length > 0) {
      <mat-table
        [dataSource]="section.data"
        class="mat-elevation-z2"
      >
      <!-- Ship Column -->
      <!-- For viewers: Ship name is plain text. For others: Clickable link to edit trip -->
      <ng-container matColumnDef="ship">
        <mat-header-cell *matHeaderCellDef> Vessel Name </mat-header-cell>
        <mat-cell *matCellDef="let element">
          @if (isViewer()) {
            <!-- Viewers see plain text, no click handler -->
            <span>{{ element.shipName }}</span>
          } @else {
            <!-- Non-viewers can click to edit trip details -->
            <span 
              class="ship-name-link" 
              (click)="editTrip(element)"
              matTooltip="Click to edit trip details"
            >
              {{ element.shipName }}
            </span>
          }
        </mat-cell>
      </ng-container>

      <!-- Marine Traffic Column -->
      <!-- Displays link to Marine Traffic vessel tracking using stored URL and custom logo -->
      <ng-container matColumnDef="marine-traffic">
        <mat-header-cell *matHeaderCellDef> Marine Traffic </mat-header-cell>
        <mat-cell *matCellDef="let element">
          <!-- Only display link if marineTrafficLink exists in the data -->
          @if (element.marineTrafficLink) {
            <a 
              [href]="element.marineTrafficLink" 
              target="_blank" 
              rel="noopener noreferrer"
              class="marine-traffic-link"
              matTooltip="View on Marine Traffic"
            >
              <img 
                src="/MarineTraffic.png" 
                alt="Marine Traffic" 
                style="height: 20px; width: auto; display: block;"
              />
            </a>
          }
          <!-- Show dash/placeholder if no link available -->
          @if (!element.marineTrafficLink) {
            <span style="color: #ccc;">â€”</span>
          }
        </mat-cell>
      </ng-container>

      <!-- Office Time (ETA/ETB/ETS) Column - Header changes dynamically -->
      <!-- For viewers: Read-only display. For others: Clickable to update date/time -->
      <ng-container matColumnDef="officeTime">
        <mat-header-cell *matHeaderCellDef> {{ section.timeLabel }} </mat-header-cell>
        <mat-cell
          *matCellDef="let element"
          [class.clickable-cell]="!isViewer()"
          (click)="!isViewer() && openEtaDialog(element)"
          [matTooltip]="!isViewer() ? 'Click to update ' + section.timeLabel : ''"
          [style.color]="
            element.isTimeSet && isPastDue(getDate(element.date))
              ? 'red'
              : 'inherit'
          "
        >
          @if (element.isTimeSet) {
            <span>{{ getDate(element.date) | date : "EEE dd/MM HH:mm" }}</span>
          }
          @if (!element.isTimeSet) {
            <span class="not-set">Not Set</span>
          }
        </mat-cell>
      </ng-container>

      <!-- Port Column -->
      <ng-container matColumnDef="port">
        <mat-header-cell *matHeaderCellDef> Port </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{ element.port }} </mat-cell>
      </ng-container>

      <!-- Note Column -->
      <ng-container matColumnDef="note">
        <mat-header-cell *matHeaderCellDef> Note </mat-header-cell>
        <mat-cell *matCellDef="let element"> {{ element.note }} </mat-cell>
      </ng-container>

      <!-- Pilot Column -->
      <!-- For viewers: Plain text display. For others: Editable dropdown -->
      <ng-container matColumnDef="pilot">
        <mat-header-cell *matHeaderCellDef> Pilot </mat-header-cell>
        <mat-cell *matCellDef="let element">
          @if (isViewer()) {
            <!-- Viewers see plain text, no dropdown -->
            <span>{{ element.pilot || 'Unassigned' }}</span>
          } @else {
            <!-- Non-viewers can edit via dropdown -->
            <mat-select 
              [value]="element.pilot"
              (selectionChange)="updatePilot(element, $event.value)"
              class="pilot-select"
              [disabled]="!element.tripId"
            >
              <mat-option value="">Unassigned</mat-option>
              <mat-option *ngFor="let pilot of pilotService.pilotNames()" [value]="pilot">
                {{ pilot }}
              </mat-option>
            </mat-select>
          }
        </mat-cell>
      </ng-container>

      <!-- Updated Column -->
      <ng-container matColumnDef="updated">
        <mat-header-cell *matHeaderCellDef> Updated </mat-header-cell>
        <mat-cell
          *matCellDef="let element"
          class="update-info"
          [ngClass]="getSourceClass(element)"
        >
          <div>
            {{ getDate(element.updatedAt) | timeAgo }} by
            {{ element.updatedBy }}
          </div>
          <div>from {{ getSource(element) }}</div>
        </mat-cell>
      </ng-container>

      <!-- Actions Column -->
      <!-- Viewers cannot change status, so we hide this column entirely for them -->
      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef> Actions </mat-header-cell>
        <mat-cell *matCellDef="let element">
          @if (!isViewer()) {
            <!-- Status Change Menu (only visible to non-viewers) -->
            <button
              mat-icon-button
              [matMenuTriggerFor]="statusMenu"
              matTooltip="Change Status"
            >
              <mat-icon>sync_alt</mat-icon>
            </button>
            <mat-menu #statusMenu="matMenu">
              <button 
                mat-menu-item 
                *ngFor="let status of getNextStatuses(element.status)"
                (click)="changeStatus(element, status)"
              >
                {{ status }}
              </button>
            </mat-menu>
          }
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
      </mat-table>
    }
  </ng-container>
</div>
